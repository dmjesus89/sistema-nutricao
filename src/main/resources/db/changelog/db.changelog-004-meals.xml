<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                   http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.1.xsd">

    <!-- Epic 4 - Meals Management -->
    <changeSet id="004-001-create-meals-table" author="nutrition-system">
        <comment>Create meals table for user meal management</comment>

        <createTable tableName="meals">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(200)">
                <constraints nullable="false"/>
            </column>
            <column name="meal_time" type="TIME">
                <constraints nullable="false"/>
            </column>
            <column name="user_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="consumed" type="BOOLEAN" defaultValue="false">
                <constraints nullable="false"/>
            </column>

            <column name="consumed_at" type="TIMESTAMP"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP"
                    defaultValueComputed="CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP"/>
        </createTable>

        <!-- Add foreign key constraint -->
        <addForeignKeyConstraint baseTableName="meals"
                                 baseColumnNames="user_id"
                                 constraintName="fk_meals_user_id"
                                 referencedTableName="users"
                                 referencedColumnNames="id"
                                 onDelete="CASCADE"/>

        <!-- Add indexes for performance -->
        <createIndex indexName="idx_meals_user_id" tableName="meals">
            <column name="user_id"/>
        </createIndex>

        <createIndex indexName="idx_meals_user_meal_time" tableName="meals">
            <column name="user_id"/>
            <column name="meal_time"/>
        </createIndex>

        <createIndex indexName="idx_meals_created_at" tableName="meals">
            <column name="created_at"/>
        </createIndex>

        <createIndex indexName="idx_meals_name" tableName="meals">
            <column name="name"/>
        </createIndex>

        <createIndex indexName="idx_meals_user_created_date" tableName="meals">
            <column name="user_id"/>
            <column name="created_at"/>
        </createIndex>
    </changeSet>

    <changeSet id="004-002-create-meal-foods-table" author="nutrition-system">
        <comment>Create meal_foods junction table linking meals to foods with quantities</comment>

        <createTable tableName="meal_foods">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="meal_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="food_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="quantity" type="DECIMAL(8,2)">
                <constraints nullable="false"/>
            </column>
            <column name="unit" type="VARCHAR(20)" defaultValue="g"/>
        </createTable>

        <!-- Add foreign key constraints -->
        <addForeignKeyConstraint baseTableName="meal_foods"
                                 baseColumnNames="meal_id"
                                 constraintName="fk_meal_foods_meal_id"
                                 referencedTableName="meals"
                                 referencedColumnNames="id"
                                 onDelete="CASCADE"/>

        <addForeignKeyConstraint baseTableName="meal_foods"
                                 baseColumnNames="food_id"
                                 constraintName="fk_meal_foods_food_id"
                                 referencedTableName="foods"
                                 referencedColumnNames="id"
                                 onDelete="CASCADE"/>

        <!-- Add indexes for performance -->
        <createIndex indexName="idx_meal_foods_meal_id" tableName="meal_foods">
            <column name="meal_id"/>
        </createIndex>

        <createIndex indexName="idx_meal_foods_food_id" tableName="meal_foods">
            <column name="food_id"/>
        </createIndex>


    </changeSet>

    <changeSet id="004-003-add-table-comments" author="nutrition-system">
        <comment>Add table comments for documentation</comment>

        <setTableRemarks tableName="meals"
                         remarks="Stores user meals with timing information"/>

        <setTableRemarks tableName="meal_foods"
                         remarks="Junction table linking meals to foods with quantities"/>
    </changeSet>

</databaseChangeLog>